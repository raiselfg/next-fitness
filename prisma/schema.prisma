generator client {
  provider        = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id
  name          String
  email         String
  emailVerified Boolean
  image         String
  createdAt     DateTime
  updatedAt     DateTime

  role          String?   @default("user")
  gender        String?
  bodyFat       Int?
  birthDate     DateTime?
  height        Int?
  weight        Int?

  meals         Int?
  location      String?
  frequency     Int?

  sessions      Session[]
  accounts      Account[]
  programs      Program[]
  dailyLogs     DailyLog[]
  nutritionGoals NutritionGoal[]

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime
  updatedAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime

  @@map("account")
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@map("verification")
}

// --- CORE: NUTRITION & LOGS ---

model NutritionGoal {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  calories Int
  protein  Int
  carbs    Int
  fats      Int

  createdAt DateTime @default(now())

  @@map("nutrition_goal")
}

model DailyLog {
  id     String   @id @default(cuid())
  userId String
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date   DateTime @db.Date

  currentWeight  Int
  currentBodyFat Int

  // 1. Питание (Факт)
  consumedCalories Int
  consumedProtein  Int
  consumedCarbs    Int
  consumedFats      Int

  // 2. Питание (План)
  targetCalories   Int
  targetProtein    Int
  targetCarbs      Int
  targetFats        Int

  meals    Meal[]
  workouts WorkoutSession[]

  @@unique([userId, date])
  @@map("daily_log")
}

model Meal {
  id         String   @id @default(cuid())
  dailyLogId String
  dailyLog   DailyLog @relation(fields: [dailyLogId], references: [id], onDelete: Cascade)

  name     String
  calories Int
  protein  Int
  carbs    Int
  fats      Int
  
  createdAt DateTime @default(now())

  @@map("meal")
}

// --- CORE: WORKOUTS ---

model Program {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name      String
  description String? // Полезно добавить описание
  isActive  Boolean @default(true)

  workouts  WorkoutTemplate[]
  createdAt DateTime @default(now())

  @@map("program")
}

model WorkoutTemplate {
  id        String  @id @default(cuid())
  programId String
  program   Program @relation(fields: [programId], references: [id], onDelete: Cascade)

  name      String
  dayOfWeek Int?    // 0 = Sunday, 1 = Monday...

  exercises PlannedExercise[]
  
  // Обратная связь для истории
  sessions  WorkoutSession[] 

  @@map("workout_template")
}

model Exercise {
  id           String  @id @default(cuid())
  name         String
  muscleGroup  String
  videoUrl     String?
  instructions String?
  
  logs      ExerciseLog[]
  plannedIn PlannedExercise[]

  @@map("exercise")
}

model PlannedExercise {
  id                String          @id @default(cuid())
  workoutTemplateId String
  workoutTemplate   WorkoutTemplate @relation(fields: [workoutTemplateId], references: [id], onDelete: Cascade)

  exerciseId String
  exercise   Exercise @relation(fields: [exerciseId], references: [id])

  sets       Int
  reps       String // "8-12" или "Failure"
  order      Int    // Порядок упражнений

  @@map("planned_exercise")
}

// --- LOGGING WORKOUTS ---

model WorkoutSession {
  id         String   @id @default(cuid())
  dailyLogId String
  dailyLog   DailyLog @relation(fields: [dailyLogId], references: [id], onDelete: Cascade)
  
  workoutTemplateId String?
  workoutTemplate   WorkoutTemplate? @relation(fields: [workoutTemplateId], references: [id], onDelete: SetNull)

  name        String
  completedAt DateTime  @default(now())

  exercises ExerciseLog[]

  @@map("workout_session")
}

model ExerciseLog {
  id               String         @id @default(cuid())
  workoutSessionId String
  workoutSession   WorkoutSession @relation(fields: [workoutSessionId], references: [id], onDelete: Cascade)

  exerciseId String
  exercise   Exercise @relation(fields: [exerciseId], references: [id])

  sets       SetLog[]
  
  order      Int     @default(0) // Порядок выполнения

  @@map("exercise_log")
}

model SetLog {
  id            String      @id @default(cuid())
  exerciseLogId String
  exerciseLog   ExerciseLog @relation(fields: [exerciseLogId], references: [id], onDelete: Cascade)

  weight      Int   // Вес
  reps        Int     // Повторения
  rpe         Int?    // Rate of Perceived Exertion (1-10) - круто для аналитики

  createdAt   DateTime @default(now()) // Чтобы сортировать подходы

  @@map("set_log")
}